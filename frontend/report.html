<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Báo Cáo Lương - Payroll System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <script src="report.js"></script>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">Payroll System</a>
        <div class="navbar-nav">
          <a class="nav-link" href="attendance.html"
            ><i class="bi bi-calendar-check"></i> Chấm công</a
          >
          <a class="nav-link" href="payroll.html"
            ><i class="bi bi-cash-coin"></i> Tính lương</a
          >
          <a class="nav-link active" href="report.html"
            ><i class="bi bi-bar-chart-line"></i> Báo cáo</a
          >
          <a class="nav-link" href="employee.html"
            ><i class="bi bi-person-plus"></i> Nhân viên</a
          >
        </div>
      </div>
    </nav>

    <div class="container py-5">
      <h2 class="mb-4">Báo Cáo Lương</h2>

      <!-- Bộ lọc tháng -->
      <div class="d-flex align-items-center mb-3">
        <label class="me-2 fw-bold">Chọn tháng:</label>
        <input type="month" id="monthInput" class="form-control w-auto" />
      </div>

      <!-- Bảng báo cáo -->
      <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Tên nhân viên</th>
            <th>Tháng báo cáo</th>
            <th>Tổng lương</th>
            <th>Trạng thái</th>
          </tr>
        </thead>
        <tbody id="reportTableBody">
          <tr>
            <td colspan="5" class="text-center text-muted">Chưa có dữ liệu</td>
          </tr>
        </tbody>
      </table>

      <!-- Nút xuất -->
      <div class="mt-3">
        <button id="exportExcel" class="btn btn-success me-2">
          <i class="bi bi-file-earmark-excel"></i> Xuất Excel
        </button>
        <button id="exportPDF" class="btn btn-danger">
          <i class="bi bi-file-earmark-pdf"></i> Xuất PDF
        </button>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api/report";
      const monthInput = document.getElementById("monthInput");
      const tableBody = document.getElementById("reportTableBody");
      const btnExcel = document.getElementById("exportExcel");
      const btnPDF = document.getElementById("exportPDF");

      async function loadReport() {
        if (!monthInput.value) return;
        const [year, month] = monthInput.value.split("-");
        const res = await fetch(`${API_URL}/baocao/${year}/${month}`);
        const data = await res.json();

        if (!data.length) {
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">Không có dữ liệu</td></tr>';
          return;
        }

        tableBody.innerHTML = data
          .map(
            (r) => `
            <tr>
              <td>${r.id}</td>
              <td>${r.ho_ten}</td>
              <td>${r.thang}</td>
              <td>${Number(r.tong_luong).toLocaleString("vi-VN")} ₫</td>
              <td>${r.trang_thai || "Chưa duyệt"}</td>
            </tr>`
          )
          .join("");
      }

      // Sự kiện chọn tháng
      monthInput.addEventListener("change", loadReport);

      // Xuất Excel
      btnExcel.addEventListener("click", () => {
        if (!monthInput.value) return alert("Vui lòng chọn tháng!");
        const [year, month] = monthInput.value.split("-");
        window.open(`${API_URL}/export/excel/${year}/${month}`, "_blank");
      });

      // Xuất PDF
      btnPDF.addEventListener("click", () => {
        if (!monthInput.value) return alert("Vui lòng chọn tháng!");
        const [year, month] = monthInput.value.split("-");
        window.open(`${API_URL}/export/pdf/${year}/${month}`, "_blank");
      });
    </script>
  </body>
</html>
