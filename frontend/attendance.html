<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ch·∫•m c√¥ng - Qu·∫£n l√Ω l∆∞∆°ng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      input[type="text"] {
        text-align: center;
        font-family: monospace;
      }
      td, th {
        vertical-align: middle;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h2 class="mb-4 text-center">üïí Ch·∫•m C√¥ng Nh√¢n Vi√™n (24h)</h2>

      <div class="card p-4 shadow-sm mb-4">
        <div class="mb-3">
          <label class="form-label fw-bold">Ch·ªçn ng√†y ch·∫•m c√¥ng</label>
          <input type="date" id="chamCongDate" class="form-control" required />
        </div>
        <button id="saveAttendance" class="btn btn-primary mt-2 w-100">
          üíæ L∆∞u ch·∫•m c√¥ng
        </button>
      </div>

      <table
        class="table table-bordered table-striped shadow-sm text-center align-middle"
        id="employeeTable"
      >
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>T√™n nh√¢n vi√™n</th>
            <th>Gi·ªù v√†o (24h)</th>
            <th>Gi·ªù ra (24h)</th>
            <th>S·ªë gi·ªù l√†m</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      // üîπ T·∫£i danh s√°ch nh√¢n vi√™n t·ª´ backend
      async function loadEmployees() {
        const res = await fetch("http://localhost:3000/api/chamcong/nhanvien/all");
        const data = await res.json();
        const tbody = document.querySelector("#employeeTable tbody");
        tbody.innerHTML = data
          .map(
            (nv, i) => `
          <tr data-id="${nv.id}">
            <td>${i + 1}</td>
            <td>${nv.ho_ten}</td>
            <td><input type="text" class="form-control gio-vao" placeholder="HH:MM" pattern="^([01]\\d|2[0-3]):[0-5]\\d$"></td>
            <td><input type="text" class="form-control gio-ra" placeholder="HH:MM" pattern="^([01]\\d|2[0-3]):[0-5]\\d$"></td>
            <td class="so-gio">0.00</td>
          </tr>`
          )
          .join("");
      }

      // üîπ T√≠nh s·ªë gi·ªù l√†m (h·ªó tr·ª£ qua ƒë√™m)
      function tinhSoGio(row) {
        const vao = row.querySelector(".gio-vao").value;
        const ra = row.querySelector(".gio-ra").value;

        const regex = /^([01]\d|2[0-3]):[0-5]\d$/;

        if (regex.test(vao) && regex.test(ra)) {
          const [hv, mv] = vao.split(":").map(Number);
          const [hr, mr] = ra.split(":").map(Number);
          let start = hv * 60 + mv;
          let end = hr * 60 + mr;

          if (end < start) end += 24 * 60; // ca ƒë√™m

          const diff = (end - start) / 60;
          row.querySelector(".so-gio").textContent = diff.toFixed(2);
        } else {
          row.querySelector(".so-gio").textContent = "0.00";
        }
      }

      // üîπ T·ª± ƒë·ªông t√≠nh khi nh·∫≠p gi·ªù
      document.addEventListener("input", (e) => {
        if (
          e.target.classList.contains("gio-vao") ||
          e.target.classList.contains("gio-ra")
        ) {
          tinhSoGio(e.target.closest("tr"));
        }
      });

      // üîπ L∆∞u ch·∫•m c√¥ng
      document
        .getElementById("saveAttendance")
        .addEventListener("click", async () => {
          const ngay = document.getElementById("chamCongDate").value;
          if (!ngay) return alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ng√†y ch·∫•m c√¥ng!");

          const rows = document.querySelectorAll("#employeeTable tbody tr");
          let count = 0;

          for (const row of rows) {
            const id = row.dataset.id;
            const gio_vao = row.querySelector(".gio-vao").value;
            const gio_ra = row.querySelector(".gio-ra").value;
            const so_gio = row.querySelector(".so-gio").textContent;

            const regex = /^([01]\d|2[0-3]):[0-5]\d$/;
            if (!regex.test(gio_vao) || !regex.test(gio_ra)) continue;

            await fetch("http://localhost:3000/api/chamcong", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                nhan_vien_id: id,
                ngay,
                gio_vao,
                gio_ra,
                so_gio_lam: so_gio,
                ghi_chu: "Ch·∫•m c√¥ng 24h"
              }),
            });
            count++;
          }

          alert(`‚úÖ ƒê√£ l∆∞u ${count} b·∫£n ghi ch·∫•m c√¥ng cho ng√†y ${ngay}`);
        });

      loadEmployees();
    </script>
  </body>
</html>
